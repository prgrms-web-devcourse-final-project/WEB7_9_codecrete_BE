name: NCB CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: test
      SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_UPPER=false
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: ""

      # JWT í‚¤ ì •ë„ëŠ” í…ŒìŠ¤íŠ¸ì—ì„œ í•„ìš”í•  ìˆ˜ ìžˆìŒ â†’ secrets ì— ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
      JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-jwt-secret' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: ./gradlew clean test --no-daemon

      # JaCoCo ë³´ê³ ì„œ ìƒì„±
      - name: Generate JaCoCo Report
        if: always()
        run: ./gradlew jacocoTestReport --no-daemon

      # JUnit ê²°ê³¼ ì—…ë¡œë“œ
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            build/test-results/test/*.xml
          check_run: true
          comment_mode: always

      - name: Upload JaCoCo HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-html
          path: build/reports/jacoco/test/html
          if-no-files-found: warn

      # ì»¤ë²„ë¦¬ì§€ ê³„ì‚°ìš© xmllint ì„¤ì¹˜
      - name: Install xmllint
        if: always()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      # PRì— ì»¤ë²„ë¦¬ì§€ ê³„ì‚°í•˜ì—¬ ì½”ë©˜íŠ¸ ì—…ì„œíŠ¸
      - name: Compute Coverage
        if: always() && github.event_name == 'pull_request'
        id: coverage
        run: |
          XML="build/reports/jacoco/test/jacocoTestReport.xml"
          if [ ! -f "$XML" ]; then
            echo "pct=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          COVERED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@covered))" "$XML")
          MISSED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@missed))" "$XML")

          TOTAL=$(( ${COVERED%.*} + ${MISSED%.*} ))
          if [ "$TOTAL" -eq 0 ]; then
            echo "pct=0" >> $GITHUB_OUTPUT
          else
            PCT=$(awk "BEGIN { printf \"%.2f\", ($COVERED / ($COVERED + $MISSED)) * 100 }")
            echo "pct=$PCT" >> $GITHUB_OUTPUT
          fi

      - name: Upsert PR coverage comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PCT: ${{ steps.coverage.outputs.pct }}
        with:
          script: |
            const pct = process.env.PCT || "0";
            const MARK = "<!-- NCB-JACOCO-COVERAGE -->";

            const body = `
            ${MARK}
            ### ðŸ“Š Test Coverage Report
            **Line Coverage:** ${pct}%

            ðŸ”— See full HTML report in GitHub Action Artifacts.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c => c.body.includes(MARK));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }