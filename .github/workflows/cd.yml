name: CD - Blue Green Deploy

on:
  push:
    branches: [ release ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ÏÜåÏä§ Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Docker Hub Î°úÍ∑∏Ïù∏
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú & Ìë∏Ïãú
      - name: Build & Push Docker Image
        run: |
          docker build -t heygeeji/ncb-backend:latest .
          docker push heygeeji/ncb-backend:latest

      # 4. EC2 Î∞∞Ìè¨ (Blue/Green + Rollback)
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/deploy

            echo "üîç Detecting active container..."

            if docker ps --filter "name=concert-spring-blue" --format "{{.Status}}" | grep -q healthy; then
              ACTIVE=blue
              TARGET=green
              PORT=8082
            else
              ACTIVE=green
              TARGET=blue
              PORT=8081
            fi

            echo "üü¶ Active: $ACTIVE"
            echo "üü© Deploy target: $TARGET"

            echo "üì• Pull latest image"
            docker compose -f docker-compose-prod.yml pull spring-$TARGET

            echo "üöÄ Start spring-$TARGET"
            docker compose -f docker-compose-prod.yml up -d spring-$TARGET

            echo "‚è≥ Waiting for health check on $PORT..."
            for i in {1..20}; do
              if curl -sf http://localhost:$PORT/actuator/health > /dev/null; then
                echo "‚úÖ spring-$TARGET is healthy"
                exit 0
              fi
              echo "‚è≥ still waiting..."
              sleep 5
            done

            echo "‚ùå Health check failed for spring-$TARGET - rolling back"
            docker compose -f docker-compose-prod.yml stop spring-$TARGET
            exit 1
