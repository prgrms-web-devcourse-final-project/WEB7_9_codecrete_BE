name: CD - Blue Green Deploy

on:
  push:
    branches: [ release ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build & Push Docker Image
        run: |
          docker build -t heygeeji/ncb-backend:latest .
          docker push heygeeji/ncb-backend:latest

      # 4. EC2 ë°°í¬ (Blue/Green + Rollback)
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/deploy

            echo "ðŸ” Reading active slot..."
            ACTIVE=$(cat active-slot.txt)

            if [ "$ACTIVE" = "blue" ]; then
              TARGET=green
              PORT=8082
            else
              TARGET=blue
              PORT=8081
            fi

            echo "ðŸŸ¦ Active: $ACTIVE"
            echo "ðŸŸ© Deploy target: $TARGET"

            echo "ðŸ“¥ Pull latest image"
            docker compose -f docker-compose-prod.yml pull spring-$TARGET

            echo "ðŸš€ Start spring-$TARGET"
            docker compose -f docker-compose-prod.yml up -d spring-$TARGET

            echo "â³ Waiting for health check on $PORT..."
            HEALTHY=false
            for i in {1..20}; do
              if curl -sf http://localhost:$PORT/actuator/health > /dev/null; then
                HEALTHY=true
                break
              fi
              echo "â³ still waiting..."
              sleep 5
            done
          
            if [ "$HEALTHY" != "true" ]; then
              echo "âŒ Health check failed for spring-$TARGET - rolling back"
              docker compose -f docker-compose-prod.yml stop spring-$TARGET
              exit 1
            fi
          
            echo "âœ… spring-$TARGET is healthy"
          
            echo "ðŸ”€ (MANUAL) Switch NPM forward port to $PORT"
            echo "âœï¸ Update active slot"
            echo "$TARGET" > active-slot.txt
    
            echo "ðŸ›‘ Stop old container: spring-$ACTIVE"
            docker compose -f docker-compose-prod.yml stop spring-$ACTIVE
          
            echo "ðŸŽ‰ Blue/Green deployment completed"